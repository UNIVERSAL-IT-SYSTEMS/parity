Index: ChangeLog
===================================================================
RCS file: /sources/libtool/libtool/ChangeLog,v
retrieving revision 1.2590
diff -u -r1.2590 ChangeLog
--- ChangeLog	11 Feb 2008 21:51:42 -0000	1.2590
+++ ChangeLog	13 Feb 2008 09:39:24 -0000
@@ -1,3 +1,50 @@
+2008-02-12  Markus Duft <markus.duft@salomon.at>
+
+	Implemented support for *-winnt*, which is the "parity"
+	compiler for windows (http://www.sf.net/projects/parity):
+
+	* libltdl/config/ltmain.m4sh: recognize winnt as Windows OS,
+	specially handle parity compiler (force C++), don't handle
+	.exe extensions like on cygwin and mingw, but like on UNIX.
+	Disable the use of reloadable objects (not supported).
+	* libltdl/libltdl/lt_system.h: Only define R_OK if it's not
+	allready defined elsewhere on Windows.
+	* libltdl/loaders/dlopen.c: Don't use RTLD_GLOBAL with parity.
+	* libltdl/loaders/loadlibrary.c: In case LoadLibrary is used
+	instead of dlopen, convert paths to windows-style for the
+	Windows API's (dlopen does this otherwise).
+	* libltdl/m4/argz.m4: Windows (parity) has no argz support.
+	* libltdl/m4/libtool.m4: Added winnt support.
+	* libltdl/m4/ltdl.m4: On winnt dlopen opens deplibs.
+	* tests/configure-iface.at: Fix output for testsuite.
+	* tests/ctor.at: Use dllimport for correct link.
+	* tests/destdir.at: Add $EXEEXT to output filenames.
+	* tests/duplicate_conv.at: Don't execute the part of the test
+	that relies on reloadable objects (not supported).
+	* tests/export.at: Need explicit export of uninitialized data,
+	use the LIBA_SCOPE define instead of extern.
+	* tests/link-order.at: Use dllimport for correct link.
+	* tests/link-order2.at: XFAIL on winnt. Windows has no RTL.
+	* tests/lt_dladvise.at: Fix output for testsuite. Use
+	dllimport for correct link. Don't test undefined symbols.
+	* tests/lt_dlexit.at: Use dllimport for correct link.
+	* tests/need_lib_prefix.at: Fix output for testsuite.
+	* tests/stresstest.at: Need explicit export of uninitialized
+	data, use the LIBA_SCOPE define instead of extern. link the
+	main-static object only when -static is given.
+	* tests/template.at: Add dependent libs to link line. There
+	is no support for undefined symbols on winnt.
+	* tests/testsuite.at: the *_EXEC_CHECK macros know of $EXEEXT
+	* tests/demo/foo.c tests/demo/foo.h tests/depdemo/l1/l1.c 
+	tests/depdemo/l1/l1.h tests/depdemo/l2/l2.c
+	tests/depdemo/l2/l2.h tests/depdemo/l3/l3.c
+	tests/depdemo/l3/l3.h tests/depdemo/l4/l4.c
+	tests/depdemo/l4/l4.h: Use dllimport for correct link.
+	* tests/mdemo/foo1.c tests/mdemo/foo2.c: Initialize global
+	data, otherwise dllexport would be required.
+	* tests/pdemo/foo.h tests/pdemo/longer_file_name_foo.c: Use
+	dllimport for correct link.
+
 2008-02-11  Ralf Wildenhues  <Ralf.Wildenhues@gmx.de>
 
 	* tests/mdemo/Makefile.am (@LIBLTDL@): Update outdated
Index: libltdl/config/ltmain.m4sh
===================================================================
RCS file: /sources/libtool/libtool/libltdl/config/ltmain.m4sh,v
retrieving revision 1.97
diff -u -r1.97 ltmain.m4sh
--- libltdl/config/ltmain.m4sh	28 Jan 2008 15:49:46 -0000	1.97
+++ libltdl/config/ltmain.m4sh	13 Feb 2008 09:39:25 -0000
@@ -993,7 +993,7 @@
 } lt_dlsymlist;
 "
 	  case $host in
-	  *cygwin* | *mingw* )
+	  *cygwin* | *mingw* | *winnt*)
 	    $ECHO >> "$output_objdir/$my_dlsyms" "\
 /* DATA imports from DLLs on WIN32 con't be const, because
    runtime relocations are performed -- see ld's documentation
@@ -1070,8 +1070,19 @@
 	  esac
 	done
 
+  #
+  # if parity is used as compiler, we need to use -xc++ to force
+  # the C file into C++ to be able to use non-const initializers
+  # for variables (other variables from shared libraries for example)
+  #
+  case "$CC" in
+  *parity*)
+    PARITY_CFLAGS="-xc++"
+    ;;
+  esac
+
 	# Now compile the dynamic symbol file.
-	func_show_eval '(cd $output_objdir && $LTCC$symtab_cflags -c$no_builtin_flag$pic_flag_for_symtable "$my_dlsyms")' 'exit $?'
+	func_show_eval '(cd $output_objdir && $LTCC$symtab_cflags $PARITY_CFLAGS -c$no_builtin_flag$pic_flag_for_symtable "$my_dlsyms")' 'exit $?'
 
 	# Clean up the generated files.
 	func_show_eval '$RM "$output_objdir/$my_dlsyms" "$nlist" "${nlist}S" "${nlist}T"'
@@ -2115,16 +2126,21 @@
 	# If the file is missing, and there is a .exe on the end, strip it
 	# because it is most likely a libtool script we actually want to
 	# install
-	stripped_ext=""
-	case $file in
-	  *.exe)
-	    if test ! -f "$file"; then
-	      func_stripname '' '.exe' "$file"
-	      file=$func_stripname_result
-	      stripped_ext=".exe"
-	    fi
-	    ;;
-	esac
+  case $host in
+  *winnt*) ;;
+  *)
+    stripped_ext=""
+    case $file in
+      *.exe)
+        if test ! -f "$file"; then
+          func_stripname '' '.exe' "$file"
+          file=$func_stripname_result
+          stripped_ext=".exe"
+        fi
+        ;;
+    esac
+    ;;
+  esac
 
 	# Do a test to see if this is really a libtool program.
 	case $host in
@@ -6102,7 +6118,7 @@
 	   len=`expr "X$test_cmds" : ".*" 2>/dev/null` &&
 	   test "$len" -le "$max_cmd_len" || test "$max_cmd_len" -le -1; then
 	  :
-	else
+	elif { case $host in *-*-winnt*) false;; *) true;; esac ; }; then
 	  # The command line is too long to link in one step, link piecewise
 	  # or, if using GNU ld and skipped_export is not :, use a linker
 	  # script.
@@ -6785,10 +6801,15 @@
       $opt_dry_run || {
 	# win32 will think the script is a binary if it has
 	# a .exe suffix, so we strip it off here.
-	case $output in
-	  *.exe) func_stripname '' '.exe' "$output"
-	         output=$func_stripname_result ;;
-	esac
+  case $host in
+  *winnt*) ;;
+  *)
+    case $output in
+      *.exe) func_stripname '' '.exe' "$output"
+             output=$func_stripname_result ;;
+    esac
+    ;;
+  esac
 	# test for cygwin because mv fails w/o .exe extensions
 	case $host in
 	  *cygwin*)
@@ -7271,17 +7292,22 @@
       *)
 	if test "$mode" = clean ; then
 	  noexename=$name
-	  case $file in
-	  *.exe)
-	    func_stripname '' '.exe' "$file"
-	    file=$func_stripname_result
-	    func_stripname '' '.exe' "$name"
-	    noexename=$func_stripname_result
-	    # $file with .exe has already been added to rmfiles,
-	    # add $file without .exe
-	    rmfiles="$rmfiles $file"
-	    ;;
-	  esac
+    case $host in
+    *winnt*) ;;
+	*)
+      case $file in
+      *.exe)
+        func_stripname '' '.exe' "$file"
+        file=$func_stripname_result
+        func_stripname '' '.exe' "$name"
+        noexename=$func_stripname_result
+        # $file with .exe has already been added to rmfiles,
+        # add $file without .exe
+        rmfiles="$rmfiles $file"
+        ;;
+      esac
+      ;;
+    esac
 	  # Do a test to see if this is a libtool program.
 	  if func_ltwrapper_p "$file"; then
 	    if func_ltwrapper_executable_p "$file"; then
Index: libltdl/libltdl/lt_system.h
===================================================================
RCS file: /sources/libtool/libtool/libltdl/libltdl/lt_system.h,v
retrieving revision 1.6
diff -u -r1.6 lt_system.h
--- libltdl/libltdl/lt_system.h	25 Mar 2007 12:12:43 -0000	1.6
+++ libltdl/libltdl/lt_system.h	13 Feb 2008 09:39:25 -0000
@@ -122,7 +122,9 @@
 # define LT_PATHSEP_CHAR	':'
 #endif
 
-#if defined(_MSC_VER) /* Visual Studio */
+/* Visual Studio - or parity, which brings a few enhancements
+ * to microsofts runtime, and uses the microsoft compiler */
+#if defined(_MSC_VER) && !defined(R_OK)
 #  define R_OK 4
 #endif
 
Index: libltdl/loaders/dlopen.c
===================================================================
RCS file: /sources/libtool/libtool/libltdl/loaders/dlopen.c,v
retrieving revision 1.12
diff -u -r1.12 dlopen.c
--- libltdl/loaders/dlopen.c	12 Jan 2008 17:00:51 -0000	1.12
+++ libltdl/loaders/dlopen.c	13 Feb 2008 09:39:25 -0000
@@ -158,7 +158,9 @@
 
   if (advise)
     {
-#ifdef RTLD_GLOBAL
+	  /* parity (winnt) has RTLD_GLOBAL defined for compatability, but
+	   * it has no effect... */
+#if defined(RTLD_GLOBAL ) && !defined(__PARITY__)
       /* If there is some means of asking for global symbol resolution,
          do so.  */
       if (((lt__advise *) advise)->is_symglobal)
Index: libltdl/loaders/loadlibrary.c
===================================================================
RCS file: /sources/libtool/libtool/libltdl/loaders/loadlibrary.c,v
retrieving revision 1.15
diff -u -r1.15 loadlibrary.c
--- libltdl/loaders/loadlibrary.c	8 May 2007 14:38:50 -0000	1.15
+++ libltdl/loaders/loadlibrary.c	13 Feb 2008 09:39:25 -0000
@@ -129,6 +129,11 @@
 #if defined(__CYGWIN__)
       cygwin_conv_to_full_win32_path (filename, wpath);
       len = 0;
+#elif defined(__PARITY__)
+      /* Use parity's internal runtime library capabilities, which
+       * aren't exposed normally... */
+      extern const char* LoaderConvertPathToNative(const char*);
+      strcpy(wpath, LoaderConvertPathToNative(filename));
 #else
       strcpy(wpath, filename);
 #endif
Index: libltdl/m4/argz.m4
===================================================================
RCS file: /sources/libtool/libtool/libltdl/m4/argz.m4,v
retrieving revision 1.6
diff -u -r1.6 argz.m4
--- libltdl/m4/argz.m4	26 Apr 2007 22:24:16 -0000	1.6
+++ libltdl/m4/argz.m4	13 Feb 2008 09:39:25 -0000
@@ -42,6 +42,10 @@
         [if argz actually works],
         [lt_cv_sys_argz_works],
         [[case $host_os in #(
+     *winnt*)
+       # Windows does not provide any argz stuff, so use our own.
+       lt_cv_sys_argz_works=no
+       ;; #(
 	 *cygwin*)
 	   lt_cv_sys_argz_works=no
 	   if test "$cross_compiling" != no; then
Index: libltdl/m4/libtool.m4
===================================================================
RCS file: /sources/libtool/libtool/libltdl/m4/libtool.m4,v
retrieving revision 1.134
diff -u -r1.134 libtool.m4
--- libltdl/m4/libtool.m4	9 Feb 2008 07:14:35 -0000	1.134
+++ libltdl/m4/libtool.m4	13 Feb 2008 09:39:26 -0000
@@ -152,6 +152,18 @@
 dnl
 AC_REQUIRE([AC_PROG_LN_S])dnl
 test -z "$LN_S" && LN_S="ln -s"
+
+# on winnt, the microsoft compiler is used behind the scenes.
+# the wrapper around it is capable of resolving links, but still
+# cl.exe chokes on header files which are linked (the wrapper
+# cannot know of these...).
+# Everybody would be happy with ln -s, except libtoolize without
+# --copy. there ln -s breaks the testsuite, since it tries to
+# compile linked source, which is nor supported by the compiler.
+case $host_os in
+winnt*) LN_S="cp -p" ;;
+esac
+
 _LT_DECL([], [LN_S], [1], [Whether we need soft or hard links])dnl
 dnl
 AC_REQUIRE([LT_CMD_MAX_LEN])dnl
@@ -1537,6 +1549,12 @@
     lt_cv_sys_max_cmd_len=196608
     ;;
 
+  winnt*)
+    # This can be any system underneath (interix or cygwin). For now handle
+    # this the same as on interix (since interix is the primary platform).
+    lt_cv_sys_max_cmd_len=196608
+    ;;
+
   osf*)
     # Dr. Hans Ekkehard Plesser reports seeing a kernel panic running configure
     # due to this test when exec_disable_arg_limit is 1 on Tru64. It is not
@@ -1993,9 +2011,19 @@
 old_striplib=
 AC_MSG_CHECKING([whether stripping libraries is possible])
 if test -n "$STRIP" && $STRIP -V 2>&1 | $GREP "GNU strip" >/dev/null; then
-  test -z "$old_striplib" && old_striplib="$STRIP --strip-debug"
-  test -z "$striplib" && striplib="$STRIP --strip-unneeded"
-  AC_MSG_RESULT([yes])
+  case $host_os in
+  winnt*)
+    # stripping is not save here, since host utils are used
+    # to work on native windows libraries (which should be the
+    # same, but we never know...)
+    AC_MSG_RESULT([no])
+    ;;
+  *)
+    test -z "$old_striplib" && old_striplib="$STRIP --strip-debug"
+    test -z "$striplib" && striplib="$STRIP --strip-unneeded"
+    AC_MSG_RESULT([yes])
+    ;;
+  esac
 else
 # FIXME - insert some real tests, host_os isn't really good enough
   case $host_os in
@@ -2386,6 +2414,104 @@
   hardcode_into_libs=yes
   ;;
 
+winnt*)
+  version_type=linux
+  need_lib_prefix=no
+  need_version=no
+  shlibpath_var=LD_LIBRARY_PATH
+  hardcode_into_libs=yes
+ 
+  #
+  # the library name should not contain any minor version
+  # numbers, since this would be too strict. Windows has
+  # the library name hardcoded always, so it won't listen
+  # to -soname's.
+  #
+  library_names_spec='${libname}${release}${shared_ext}$major ${libname}${shared_ext}'
+
+  #
+  # the real soname and dlname (which is set to soname)
+  # contains the .dll extension that parity adds.
+  #
+  soname_spec='${libname}${release}${shared_ext}$major.dll'
+  dynamic_linker='parity'
+  sys_lib_search_path_spec=
+  sys_lib_dlsearch_path_spec=
+
+  #
+  # Calculate the system library directories, by asking
+  # parity's configuration for it.
+  # WARNING: does not work correctly with paths with spaces.
+  #
+  parity_conf=
+
+  #
+  # try by asking first... This works from parity 1.0.4 onwards.
+  #
+  parity_sysconf=`$CC -v | grep Sysconf | sed -e 's,^Sysconf .*: ,,g'`
+
+  if test -n "${parity_sysconf}"; then
+    if test -d "${parity_sysconf}" -a -f "${parity_sysconf}/parity.conf"; then
+      parity_conf="${parity_sysconf}/parity.conf"
+    fi
+  fi
+
+  #
+  # couldn't determine sysconfdir, so assume, its ../etc from parity.
+  #
+  if test -z "${parity_conf}"; then
+    save_IFS=$IFS
+    IFS=$PATH_SEPARATOR
+    set dummy $PATH
+    shift
+
+    IFS=$save_IFS
+
+    for p in "$[@]"; do
+        if test -x "$p/$LD" && test -f "$p/../etc/parity.conf"; then
+            parity_conf="$p/../etc/parity.conf"
+            break
+        fi
+    done
+  fi
+
+  if test -n "${parity_conf}"; then
+    library_paths=`grep -e ".*LibraryPaths.*=" $parity_conf | sed -e "s,.*LibraryPaths.*=[[ \t]]*\(.*\)\$,\1,g"`
+    sys_lib_search_path_spec=`echo $library_paths`
+  else
+    # panic: what am i supposed to do now?
+    sys_lib_search_path_spec=
+  fi
+
+  #
+  # we assume that parity's loader feature is enabled. this
+  # enables us to use LD_LIBRARY_PATH, LD_RUN_PATH and -rpath
+  #
+  runpath_var=LD_RUN_PATH
+  shlibpath_overrides_runpath=yes
+
+  #
+  # we need seperate postinstall and postuninstall commands
+  # to carry .dll and .pdb files with us.
+  #
+  # WARNING: the commands below (especially the ${x%..} variable
+  # syntax) work perfectly on ksh (/bin/sh) and bash on interix.
+  # Other shells have not been tested and may need some porting.
+  #
+  postinstall_cmds='
+      $install_prog $dir/$dlname $destdir/$dlname~
+      test ! -f $dir/${dlname%.dll}.pdb || $install_prog $dir/${dlname%.dll}.pdb $destdir/${dlname%.dll}.pdb~
+      chmod 755 $destdir/$dlname~
+      test ! -f $destdir/${dlname%.dll}.pdb || chmod 644 $destdir/${dlname%.dll}.pdb'
+
+  postuninstall_cmds='
+      dll=`$SHELL 2>&1 -c '\''. $file;
+          echo \${dlname}'\''`~
+      pdb=\${dll%.dll}.pdb~
+      rm $dir/\$dll~
+      rm $dir/\$pdb'
+  ;;
+
 irix5* | irix6* | nonstopux*)
   case $host_os in
     nonstopux*) version_type=nonstopux ;;
@@ -3038,6 +3164,16 @@
   lt_cv_deplibs_check_method='match_pattern /lib[[^/]]+(\.so|\.a)$'
   ;;
 
+winnt*)
+  #
+  # there is no suitable file_magic, and match_patter somehow
+  # does not seem to work in all cases, namely if native windows
+  # libraries are involved in linking, which - of course - don't
+  # match the normal naming scheme.
+  #
+  lt_cv_deplibs_check_method=pass_all
+  ;;
+
 irix5* | irix6* | nonstopux*)
   case $LD in
   *-32|*"-32 ") libmagic=32-bit;;
@@ -3234,7 +3370,7 @@
 [AC_REQUIRE([AC_CANONICAL_HOST])dnl
 LIBM=
 case $host in
-*-*-beos* | *-*-cygwin* | *-*-pw32* | *-*-darwin*)
+*-*-beos* | *-*-cygwin* | *-*-pw32* | *-*-darwin* | *-winnt*)
   # These system don't have libm, or don't need it
   ;;
 *-ncr-sysv4.3*)
@@ -3346,6 +3482,25 @@
 # so use this general approach.
 lt_cv_sys_global_symbol_to_cdecl="sed -n -e 's/^T .* \(.*\)$/extern int \1();/p' -e 's/^$symcode* .* \(.*\)$/extern char \1;/p'"
 
+case $host_os in
+winnt*)
+  #
+  # parity knows how to handle dllimport declspecs when there is no
+  # shared library in play, so we use it allways to be on the safe side.
+  #
+  lt_cv_sys_global_symbol_to_cdecl="awk '{ print \"extern __declspec(dllimport) int \" \$][3 \";\" }'"
+
+  #
+  # WARNING: since parity may use the Microsoft compiler as backend
+  # symbol names could be mangled in MS style, which means, they are
+  # not valid C identifiers, so we *cannot* generate C code that
+  # tries to do something with those C++ variables, because it won't
+  # compile!
+  # This could be done in assembly which would solve this problem.
+  #
+  ;;
+esac
+
 # Transform an extracted symbol line into symbol name and symbol address
 lt_cv_sys_global_symbol_to_c_name_address="sed -n -e 's/^: \([[^ ]]*\) $/  {\\\"\1\\\", (void *) 0},/p' -e 's/^$symcode* \([[^ ]]*\) \([[^ ]]*\)$/  {\"\2\", (void *) \&\2},/p'"
 lt_cv_sys_global_symbol_to_c_name_address_lib_prefix="sed -n -e 's/^: \([[^ ]]*\) $/  {\\\"\1\\\", (void *) 0},/p' -e 's/^$symcode* \([[^ ]]*\) \(lib[[^ ]]*\)$/  {\"\2\", (void *) \&\2},/p' -e 's/^$symcode* \([[^ ]]*\) \([[^ ]]*\)$/  {\"lib\2\", (void *) \&\2},/p'"
@@ -3458,6 +3613,18 @@
 	  lt_save_CFLAGS="$CFLAGS"
 	  LIBS="conftstm.$ac_objext"
 	  CFLAGS="$CFLAGS$_LT_TAGVAR(lt_prog_compiler_no_builtin_flag, $1)"
+
+    #
+    # parity needs -xc++ to force the file in c++ mode. this is
+    # because of variables beeing initialized with non-constant
+    # values (variables from shared libraries)
+    #
+    case "$host_os" in
+    winnt*)
+      CFLAGS="${CFLAGS} -xc++"
+      ;;
+    esac
+
 	  if AC_TRY_EVAL(ac_link) && test -s conftest${ac_exeext}; then
 	    pipe_works=yes
 	  fi
@@ -3652,6 +3819,19 @@
 	# This is c89, which is MS Visual C++ (no shared libs)
 	# Anyone wants to do a port?
 	;;
+
+      winnt*)
+        #
+        # -fPIC and -fpic have the same effect for parity: none
+        # this means it's of no danger to pass it in, since parity
+        # simply ignores it, still we save some command line parsing
+        # time, when not passing it :)
+        #
+        _LT_TAGVAR(lt_prog_compiler_pic, $1)=''
+        _LT_TAGVAR(lt_prog_compiler_wl, $1)='-Wl,'
+        _LT_TAGVAR(lt_prog_compiler_static, $1)='-static'
+        ;;
+
       irix5* | irix6* | nonstopux*)
 	case $cc_basename in
 	  CC*)
@@ -3927,6 +4107,18 @@
       _LT_TAGVAR(lt_prog_compiler_static, $1)='${wl}-a ${wl}archive'
       ;;
 
+    winnt*)
+      #
+      # -fPIC and -fpic have the same effect for parity: none
+      # this means it's of no danger to pass it in, since parity
+      # simply ignores it, still we save some command line parsing
+      # time, when not passing it :)
+      #
+      _LT_TAGVAR(lt_prog_compiler_pic, $1)=''
+      _LT_TAGVAR(lt_prog_compiler_wl, $1)='-Wl,'
+      _LT_TAGVAR(lt_prog_compiler_static, $1)='-static'
+      ;;
+
     irix5* | irix6* | nonstopux*)
       _LT_TAGVAR(lt_prog_compiler_wl, $1)='-Wl,'
       # PIC (with -KPIC) is the default.
@@ -4185,6 +4377,12 @@
     # we just hope/assume this is gcc and not c89 (= MSVC++)
     with_gnu_ld=yes
     ;;
+  winnt*)
+		#
+		# parity tries to look like gnu ld, but it isn't.
+		#
+    with_gnu_ld=no
+    ;;
   openbsd*)
     with_gnu_ld=no
     ;;
@@ -4456,6 +4654,15 @@
   else
     # PORTME fill in a description of your system's linker (not GNU ld)
     case $host_os in
+
+    winnt*)
+      _LT_TAGVAR(hardcode_direct, $1)=no
+      _LT_TAGVAR(hardcode_shlibpath_var, $1)=no
+      _LT_TAGVAR(hardcode_libdir_flag_spec, $1)='${wl}-rpath,$libdir'
+      _LT_TAGVAR(archive_cmds, $1)='$CC -shared $pic_flag $libobjs $deplibs $compiler_flags -o $lib'
+      _LT_TAGVAR(archive_cmds_need_lc, $1)=no
+      ;;
+
     aix3*)
       _LT_TAGVAR(allow_undefined_flag, $1)=unsupported
       _LT_TAGVAR(always_export_symbols, $1)=yes
@@ -5746,6 +5953,15 @@
 	_LT_TAGVAR(archive_cmds, $1)='$CC -shared $pic_flag $libobjs $deplibs $compiler_flags ${wl}-h,$soname ${wl}--image-base,`expr ${RANDOM-$$} % 4096 / 2 \* 262144 + 1342177280` -o $lib'
 	_LT_TAGVAR(archive_expsym_cmds, $1)='sed "s,^,_," $export_symbols >$output_objdir/$soname.expsym~$CC -shared $pic_flag $libobjs $deplibs $compiler_flags ${wl}-h,$soname ${wl}--retain-symbols-file,$output_objdir/$soname.expsym ${wl}--image-base,`expr ${RANDOM-$$} % 4096 / 2 \* 262144 + 1342177280` -o $lib'
 	;;
+
+      winnt*)
+        _LT_TAGVAR(hardcode_direct, $1)=no
+        _LT_TAGVAR(hardcode_shlibpath_var, $1)=no
+        _LT_TAGVAR(hardcode_libdir_flag_spec, $1)='${wl}-rpath,$libdir'
+        _LT_TAGVAR(archive_cmds, $1)='$CC -shared $pic_flag $libobjs $deplibs $compiler_flags -o $lib'
+        _LT_TAGVAR(archive_cmds_need_lc, $1)=no
+        ;;
+
       irix5* | irix6*)
         case $cc_basename in
           CC*)
@@ -6422,6 +6638,17 @@
   _LT_TAGVAR(postdeps,$1)=
   ;;
 
+winnt*)
+  #
+  # parity does not have verbose output like gcc/g++ have, so
+  # most likely the above will result in nothing. But in worst case
+  # libtool may find something it thinks is a library, so reset things.
+  #
+  _LT_TAGVAR(predep_objects,$1)=
+  _LT_TAGVAR(postdep_objects,$1)=
+  _LT_TAGVAR(postdeps,$1)=
+  ;;
+
 linux*)
   case `$CC -V 2>&1 | sed 5q` in
   *Sun\ C*)
Index: libltdl/m4/ltdl.m4
===================================================================
RCS file: /sources/libtool/libtool/libltdl/m4/ltdl.m4,v
retrieving revision 1.43
diff -u -r1.43 ltdl.m4
--- libltdl/m4/ltdl.m4	31 Jan 2008 16:17:06 -0000	1.43
+++ libltdl/m4/ltdl.m4	13 Feb 2008 09:39:27 -0000
@@ -537,6 +537,9 @@
   sysv5* | sco3.2v5* | sco5v6* | unixware* | OpenUNIX* | sysv4*uw2*)
     libltdl_cv_sys_dlopen_deplibs=yes
     ;;
+  winnt*)
+    libltdl_cv_sys_dlopen_deplibs=yes
+    ;;
   esac
   ])
 if test "$lt_cv_sys_dlopen_deplibs" != yes; then
Index: tests/configure-iface.at
===================================================================
RCS file: /sources/libtool/libtool/tests/configure-iface.at,v
retrieving revision 1.6
diff -u -r1.6 configure-iface.at
--- tests/configure-iface.at	17 Jan 2008 05:32:42 -0000	1.6
+++ tests/configure-iface.at	13 Feb 2008 09:39:27 -0000
@@ -31,6 +31,11 @@
 [[#include <ltdl.h>
 #include <stdio.h>
 
+#ifdef _WIN32
+# include <fcntl.h>
+# include <io.h>
+#endif
+
 typedef int funcp (void);
 
 static int errors = 0;
@@ -42,6 +47,14 @@
 
   LTDL_SET_PRELOADED_SYMBOLS();
 
+  #ifdef _WIN32
+	/* This is to keep the testsuite from beeing confused
+	 * by \r\n line endings. This confuses the diff used to
+	 * compare expected with real output. */
+
+  _setmode(_fileno(stdout), _O_BINARY);
+  #endif
+
   if (lt_dlinit () != 0)
     {
       fprintf (stderr, "error during initialization: %s\n", lt_dlerror ());
Index: tests/ctor.at
===================================================================
RCS file: /sources/libtool/libtool/tests/ctor.at,v
retrieving revision 1.2
diff -u -r1.2 ctor.at
--- tests/ctor.at	12 Jan 2008 14:07:02 -0000	1.2
+++ tests/ctor.at	13 Feb 2008 09:39:27 -0000
@@ -30,13 +30,24 @@
 
 AT_DATA(class.h,
 [[#define magic 0xaabbccdd
+
+/* parity (winnt) supports dllimporting allways, even when building static
+ * libraries. This means we can use dllimport here in any case, since parity
+ * handles things correctly in the static case. Also dllimport is required
+ * only for data symbols. */
+#ifdef __PARITY__
+# define DLLIMPORT __declspec(dllimport)
+#else
+# define DLLIMPORT
+#endif
+
 class Foo {
 public:
 	Foo() { bar = magic; }
 	unsigned bar;
 };
 
-extern Foo instance;
+extern DLLIMPORT Foo instance;
 ]])
 
 AT_DATA(libctor.cpp,
Index: tests/destdir.at
===================================================================
RCS file: /sources/libtool/libtool/tests/destdir.at,v
retrieving revision 1.6
diff -u -r1.6 destdir.at
--- tests/destdir.at	19 Jun 2007 05:43:16 -0000	1.6
+++ tests/destdir.at	13 Feb 2008 09:39:27 -0000
@@ -56,7 +56,7 @@
 $LIBTOOL --mode=link $CC $CFLAGS $LDFLAGS -o liba.la a.lo -rpath $libdir
 echo 'extern int a(); int main() { return a(); }' > m.c
 $CC $CPPFLAGS $CFLAGS -c m.c
-$LIBTOOL --mode=link $CC $CFLAGS $LDFLAGS -o m m.$OBJEXT liba.la
+$LIBTOOL --mode=link $CC $CFLAGS $LDFLAGS -o m$EXEEXT m.$OBJEXT liba.la
 mkdir $DESTDIR$libdir $DESTDIR$bindir
 AT_CHECK([$LIBTOOL --mode=install cp liba.la $DESTDIR$libdir/liba.la],
 	 [], [ignore], [ignore])
@@ -91,7 +91,7 @@
 $LIBTOOL --mode=link $CC $CFLAGS $LDFLAGS -o liba.la a.lo -rpath $libdir liba1dep.la liba2dep.la
 echo 'extern int a(); int main() { return a(); }' > m.c
 $CC $CPPFLAGS $CFLAGS -c m.c
-$LIBTOOL --mode=link $CC $CFLAGS $LDFLAGS -o m m.$OBJEXT liba.la
+$LIBTOOL --mode=link $CC $CFLAGS $LDFLAGS -o m$EXEEXT m.$OBJEXT liba.la
 mkdir $DESTDIR$libdir $DESTDIR${libdir}2 $DESTDIR$bindir
 AT_CHECK([$LIBTOOL --mode=install cp liba1dep.la $DESTDIR$libdir/liba1dep.la],
 	 [], [ignore], [ignore])
Index: tests/duplicate_conv.at
===================================================================
RCS file: /sources/libtool/libtool/tests/duplicate_conv.at,v
retrieving revision 1.2
diff -u -r1.2 duplicate_conv.at
--- tests/duplicate_conv.at	25 Mar 2007 12:12:43 -0000	1.2
+++ tests/duplicate_conv.at	13 Feb 2008 09:39:27 -0000
@@ -75,12 +75,17 @@
 LT_AT_EXEC_CHECK([./main],[0],[ignore],[ignore])
 $LIBTOOL --mode=clean rm -f libcee.la
 
-# Test whether this works with reloadable objects as well.
-AT_CHECK([$LIBTOOL --mode=link --tag=CC $CC $CFLAGS $LDFLAGS -o cee.$OBJEXT c.lo a/liba.la b/liba.la],
-	 [0], [ignore], [ignore])
-AT_CHECK([$LIBTOOL --mode=link $CC $CFLAGS $LDFLAGS -o main main.$OBJEXT cee.$OBJEXT],
-	 [0], [ignore], [ignore])
-LT_AT_EXEC_CHECK([./main],[0],[ignore],[ignore])
+case $host_os in
+winnt*) ;; # This os does not support reloadable objects!
+*)
+  # Test whether this works with reloadable objects as well.
+  AT_CHECK([$LIBTOOL --mode=link --tag=CC $CC $CFLAGS $LDFLAGS -o cee.$OBJEXT c.lo a/liba.la b/liba.la],
+     [0], [ignore], [ignore])
+  AT_CHECK([$LIBTOOL --mode=link $CC $CFLAGS $LDFLAGS -o main main.$OBJEXT cee.$OBJEXT],
+     [0], [ignore], [ignore])
+  LT_AT_EXEC_CHECK([./main],[0],[ignore],[ignore])
+  ;;
+esac
 
 # TODO: test dlpreloading of duplicates (when it is implemented)
 
Index: tests/export.at
===================================================================
RCS file: /sources/libtool/libtool/tests/export.at,v
retrieving revision 1.4
diff -u -r1.4 export.at
--- tests/export.at	25 Mar 2007 12:12:43 -0000	1.4
+++ tests/export.at	13 Feb 2008 09:39:27 -0000
@@ -45,7 +45,19 @@
 extern "C" {
 #endif
 
-int v1;
+/* visual studio seems to behave strangely with uninitialized variables
+ * as it doesn't seem to really define those variables under certain
+ * circumstances if they are not used in this compilation unit. This will
+ * in turn prevent parity from finding this variables for auto-export.
+ * The only possible workaround for this is exporting those uninitialized
+ * variables manually (or don't use uninitialized data...). */
+#if defined(__PARITY__)
+# define DLLEXPORT __declspec(dllexport)
+#else
+# define DLLEXPORT
+#endif
+
+DLLEXPORT int v1;
 static int v2;
 int v3 = 0;
 int v4 = 1;
@@ -63,7 +75,7 @@
 int (*const v12) (void) = v9;
 
 typedef struct { int arr[1000]; } large;
-large v13;
+DLLEXPORT large v13;
 large v14 = { { 0 } };
 large v15 = { { 1 } };
 
@@ -94,7 +106,7 @@
 AT_DATA(main.c,
 [[
 #if defined(LIBA_DLL_IMPORT)
-#  if defined(_WIN32) || defined(WIN32) || defined(__CYGWIN__)
+#  if defined(_WIN32) || defined(WIN32) || defined(__CYGWIN__) || defined(__PARITY__)
 #    define LIBA_SCOPE extern __declspec(dllimport)
 #  endif
 #endif
@@ -104,21 +116,21 @@
 #ifdef __cplusplus
 extern "C" {
 #endif
-extern int v1;
-extern int v3, v4;
+LIBA_SCOPE int v1;
+LIBA_SCOPE int v3, v4;
 LIBA_SCOPE const int v5, v6;
-extern const char* v7;
-extern const char v8[];
-extern int v9(void);
-extern int (*v10) (void);
-extern int (*v11) (void);
+LIBA_SCOPE const char* v7;
+LIBA_SCOPE const char v8[];
+LIBA_SCOPE int v9(void);
+LIBA_SCOPE int (*v10) (void);
+LIBA_SCOPE int (*v11) (void);
 LIBA_SCOPE int (*const v12) (void);
 #ifdef __cplusplus
 }
 #endif
 
 typedef struct { int arr[1000]; } large;
-extern large v13, v14, v15;
+LIBA_SCOPE large v13, v14, v15;
 
 int main (void)
 {
Index: tests/link-order.at
===================================================================
RCS file: /sources/libtool/libtool/tests/link-order.at,v
retrieving revision 1.14
diff -u -r1.14 link-order.at
--- tests/link-order.at	25 Mar 2007 12:12:43 -0000	1.14
+++ tests/link-order.at	13 Feb 2008 09:39:27 -0000
@@ -48,13 +48,33 @@
   mkdir src
 
   cat >src/a_$i.c <<EOF
-extern int c;
+/* parity (winnt) supports dllimporting allways, even when building static
+ * libraries. This means we can use dllimport here in any case, since parity
+ * handles things correctly in the static case. Also dllimport is required
+ * only for data symbols. */
+#ifdef __PARITY__
+# define DLLIMPORT __declspec(dllimport)
+#else
+# define DLLIMPORT
+#endif
+
+extern DLLIMPORT int c;
 extern int b_$i();
 int a_$i() { return c + b_$i(); }
 EOF
 
   cat >src/b_$i.c <<EOF
-extern int c;
+/* parity (winnt) supports dllimporting allways, even when building static
+ * libraries. This means we can use dllimport here in any case, since parity
+ * handles things correctly in the static case. Also dllimport is required
+ * only for data symbols. */
+#ifdef __PARITY__
+# define DLLIMPORT __declspec(dllimport)
+#else
+# define DLLIMPORT
+#endif
+
+extern DLLIMPORT int c;
 int b_$i() { return 1 + c; }
 EOF
 
Index: tests/link-order2.at
===================================================================
RCS file: /sources/libtool/libtool/tests/link-order2.at,v
retrieving revision 1.6
diff -u -r1.6 link-order2.at
--- tests/link-order2.at	25 Mar 2007 12:12:43 -0000	1.6
+++ tests/link-order2.at	13 Feb 2008 09:39:27 -0000
@@ -97,6 +97,15 @@
 $LIBTOOL --mode=install cp liba0.la $deflibdir/liba0.la
 $LIBTOOL --mode=clean rm -f liba0.la
 
+# on windows the below test will not work (yet), since libb links
+# against the shared liba1.so (which returns 0), and so it will
+# allways load liba1.so and its symbols. Those will never be
+# overridden by liba0.so (which is expected here).
+# There are plans to implement runtime linking emulation in parity,
+# which would make it possible to pass this test. Still there are
+# some problems to be solved before this will be released.
+AT_XFAIL_IF([case $host_os in winnt*) true ;; *) false ;; esac])
+
 for type_of_depdepl in libtool non-libtool; do
   echo "type of depdepl: $type_of_depdepl"
   if test $type_of_depdepl = non-libtool; then
Index: tests/lt_dladvise.at
===================================================================
RCS file: /sources/libtool/libtool/tests/lt_dladvise.at,v
retrieving revision 1.4
diff -u -r1.4 lt_dladvise.at
--- tests/lt_dladvise.at	12 Jan 2008 14:07:02 -0000	1.4
+++ tests/lt_dladvise.at	13 Feb 2008 09:39:27 -0000
@@ -31,6 +31,10 @@
 AT_DATA([main.c],
 [[#include <ltdl.h>
 #include <stdio.h>
+#ifdef _WIN32
+# include <fcntl.h>
+# include <io.h>
+#endif
 
 typedef int funcp (int);
 
@@ -192,6 +196,13 @@
 int
 main (void)
 {
+  #ifdef _WIN32
+	/* This is to keep the testsuite from beeing confused
+	 * by \r\n line endings. This confuses the diff used to
+	 * compare expected with real output. */
+
+  _setmode(_fileno(stdout), _O_BINARY);
+  #endif
 
   LTDL_SET_PRELOADED_SYMBOLS();
 
@@ -249,7 +260,19 @@
 [[#ifdef __cplusplus
 extern "C" {
 #endif
-extern int f (int), i;
+
+/* parity (winnt) supports dllimporting allways, even when building static
+ * libraries. This means we can use dllimport here in any case, since parity
+ * handles things correctly in the static case. Also dllimport is required
+ * only for data symbols. */
+#ifdef __PARITY__
+# define DLLIMPORT __declspec(dllimport)
+#else
+# define DLLIMPORT
+#endif
+
+extern int f (int);
+extern DLLIMPORT int i;
 int g (int x) { return f (i) + x - 3; }
 int j = 4;
 #ifdef __cplusplus
@@ -281,6 +304,12 @@
 case $host_os in
 cygwin*)
   # These hosts do not support linking without -no-undefined
+	;;
+winnt*)
+	# This host has implicit -no-undefine behaviour. it would in
+	# theory be possible to implement linking with undefined symbols
+	# (but only at shared library boundaries!), but at the moment
+	# i don't see any advantage in doing so.
   ;;
 *)
   dlopenable="$dlopen depend"
Index: tests/lt_dlexit.at
===================================================================
RCS file: /sources/libtool/libtool/tests/lt_dlexit.at,v
retrieving revision 1.9
diff -u -r1.9 lt_dlexit.at
--- tests/lt_dlexit.at	12 Jan 2008 14:07:02 -0000	1.9
+++ tests/lt_dlexit.at	13 Feb 2008 09:39:27 -0000
@@ -108,7 +108,19 @@
 [[#ifdef __cplusplus
 extern "C" {
 #endif
-extern int f1 (int), v1;
+
+/* parity (winnt) supports dllimporting allways, even when building static
+ * libraries. This means we can use dllimport here in any case, since parity
+ * handles things correctly in the static case. Also dllimport is required
+ * only for data symbols. */
+#ifdef __PARITY__
+# define DLLIMPORT __declspec(dllimport)
+#else
+# define DLLIMPORT
+#endif
+
+extern int f1 (int);
+extern DLLIMPORT int v1;
 int fb1 (int x) { return f1 (v1) + x - 3; }
 int vb1 = 3;
 #ifdef __cplusplus
Index: tests/need_lib_prefix.at
===================================================================
RCS file: /sources/libtool/libtool/tests/need_lib_prefix.at,v
retrieving revision 1.2
diff -u -r1.2 need_lib_prefix.at
--- tests/need_lib_prefix.at	12 Jan 2008 11:25:03 -0000	1.2
+++ tests/need_lib_prefix.at	13 Feb 2008 09:39:27 -0000
@@ -29,6 +29,11 @@
 [[#include <ltdl.h>
 #include <stdio.h>
 
+#ifdef _WIN32
+# include <fcntl.h>
+# include <io.h>
+#endif
+
 typedef int fun (int);
 
 static int errors = 0;
@@ -89,6 +94,14 @@
 
   LTDL_SET_PRELOADED_SYMBOLS();
 
+  #ifdef _WIN32
+	/* This is to keep the testsuite from beeing confused
+	 * by \r\n line endings. This confuses the diff used to
+	 * compare expected with real output. */
+
+  _setmode(_fileno(stdout), _O_BINARY);
+  #endif
+
   if (lt_dlinit() != 0)
     {
       fprintf (stderr, "error during initialization: %s\n", lt_dlerror());
Index: tests/stresstest.at
===================================================================
RCS file: /sources/libtool/libtool/tests/stresstest.at,v
retrieving revision 1.16
diff -u -r1.16 stresstest.at
--- tests/stresstest.at	3 Apr 2007 19:09:39 -0000	1.16
+++ tests/stresstest.at	13 Feb 2008 09:39:27 -0000
@@ -39,7 +39,20 @@
 #ifdef __cplusplus
 extern "C" {
 #endif
-int v1;
+
+/* visual studio seems to behave strangely with uninitialized variables
+ * as it doesn't seem to really define those variables under certain
+ * circumstances if they are not used in this compilation unit. This will
+ * in turn prevent parity from finding this variables for auto-export.
+ * The only possible workaround for this is exporting those uninitialized
+ * variables manually (or don't use uninitialized data...). */
+#if defined(__PARITY__)
+# define DLLEXPORT __declspec(dllexport)
+#else
+# define DLLEXPORT
+#endif
+
+DLLEXPORT int v1;
 static int v2;
 int v3 = 0;
 int v4 = 1;
@@ -57,7 +70,7 @@
 int (*const v12) (void) = v9;
 
 typedef struct { int arr[1000]; } large;
-large v13;
+DLLEXPORT large v13;
 large v14 = { { 0 } };
 large v15 = { { 1 } };
 #ifdef __cplusplus
@@ -101,21 +114,21 @@
 #ifdef __cplusplus
 extern "C" {
 #endif
-extern int v1;
-extern int v3, v4;
+LIBA_SCOPE int v1;
+LIBA_SCOPE int v3, v4;
 LIBA_SCOPE const int v5, v6;
-extern const char* v7;
-extern const char v8[];
-extern int v9(void);
-extern int (*v10) (void);
-extern int (*v11) (void);
+LIBA_SCOPE const char* v7;
+LIBA_SCOPE const char v8[];
+LIBA_SCOPE int v9(void);
+LIBA_SCOPE int (*v10) (void);
+LIBA_SCOPE int (*v11) (void);
 LIBA_SCOPE int (*const v12) (void);
 #ifdef __cplusplus
 }
 #endif
 
 typedef struct { int arr[1000]; } large;
-extern large v13, v14, v15;
+LIBA_SCOPE large v13, v14, v15;
 
 int main(void)
 {
@@ -139,18 +152,18 @@
 #ifdef __cplusplus
 extern "C" {
 #endif
-extern int v1;
-extern int v3, v4;
+LIBA_SCOPE int v1;
+LIBA_SCOPE int v3, v4;
 LIBA_SCOPE const int v5, v6;
-extern const char* v7;
-extern const char v8[];
-extern int v9(void);
-extern int (*v10) (void);
-extern int (*v11) (void);
+LIBA_SCOPE const char* v7;
+LIBA_SCOPE const char v8[];
+LIBA_SCOPE int v9(void);
+LIBA_SCOPE int (*v10) (void);
+LIBA_SCOPE int (*v11) (void);
 LIBA_SCOPE int (*const v12) (void);
 
 typedef struct { int arr[1000]; } large;
-extern large v13, v14, v15;
+LIBA_SCOPE large v13, v14, v15;
 
 extern int w1;
 extern int w3, w4;
@@ -254,7 +267,8 @@
 	do
           case $st,$l3 in
           ,-rpath*) mst= ;;
-          *) mst=-static ;;
+          -static*) mst=-static ;;
+		  *) mst= ;;
 	  esac
 
 	  LT_AT_CHECK([$LIBTOOL --mode=link $CC $CFLAGS $LDFLAGS $st -o "$rel"main "$rel"main$mst.lo "$rel"sub2/liba.la],
Index: tests/template.at
===================================================================
RCS file: /sources/libtool/libtool/tests/template.at,v
retrieving revision 1.13
diff -u -r1.13 template.at
--- tests/template.at	11 Jan 2008 07:08:28 -0000	1.13
+++ tests/template.at	13 Feb 2008 09:39:27 -0000
@@ -236,14 +236,14 @@
 # both convenience
 AT_CHECK([$LIBTOOL --tag=CXX --mode=link $CXX $CXXFLAGS $LDFLAGS -o lib/liba.la lib/a.lo],
 	 [0], [ignore], [ignore])
-AT_CHECK([$LIBTOOL --tag=CXX --mode=link $CXX $CXXFLAGS $LDFLAGS -o lib2/libb.la lib2/b.lo],
+AT_CHECK([$LIBTOOL --tag=CXX --mode=link $CXX $CXXFLAGS $LDFLAGS -o lib2/libb.la lib2/b.lo lib/liba.la],
 	 [0], [ignore], [ignore])
 AT_CHECK([$LIBTOOL --tag=CXX --mode=link $CXX $CXXFLAGS $LDFLAGS -o sub/main $main_o lib2/libb.la lib/liba.la],
 	 [0], [ignore], [ignore])
 LT_AT_EXEC_CHECK([./sub/main], [ignore])
 # lib convenience
 if $noskip; then
-  AT_CHECK([$LIBTOOL --tag=CXX --mode=link $CXX $CXXFLAGS $LDFLAGS -o lib2/libb.la lib2/b.lo -rpath /foo],
+  AT_CHECK([$LIBTOOL --tag=CXX --mode=link $CXX $CXXFLAGS $LDFLAGS -o lib2/libb.la lib2/b.lo lib/liba.la -rpath /foo],
 	   [0], [ignore], [ignore])
   AT_CHECK([$LIBTOOL --tag=CXX --mode=link $CXX $CXXFLAGS $LDFLAGS -o sub/main $main_o lib2/libb.la lib/liba.la],
 	   [0], [ignore], [ignore])
@@ -253,7 +253,7 @@
 # both installed
 AT_CHECK([$LIBTOOL --tag=CXX --mode=link $CXX $CXXFLAGS $LDFLAGS -o lib/liba.la lib/a.lo -rpath /foo],
 	 [0], [ignore], [ignore])
-AT_CHECK([$LIBTOOL --tag=CXX --mode=link $CXX $CXXFLAGS $LDFLAGS -o lib2/libb.la lib2/b.lo -rpath /bar],
+AT_CHECK([$LIBTOOL --tag=CXX --mode=link $CXX $CXXFLAGS $LDFLAGS -o lib2/libb.la lib2/b.lo lib/liba.la -rpath /bar],
 	 [0], [ignore], [ignore])
 AT_CHECK([$LIBTOOL --tag=CXX --mode=link $CXX $CXXFLAGS $LDFLAGS -o sub/main $main_o lib2/libb.la lib/liba.la],
 	 [0], [ignore], [ignore])
Index: tests/testsuite.at
===================================================================
RCS file: /sources/libtool/libtool/tests/testsuite.at,v
retrieving revision 1.51
diff -u -r1.51 testsuite.at
--- tests/testsuite.at	1 Feb 2008 19:06:42 -0000	1.51
+++ tests/testsuite.at	13 Feb 2008 09:39:27 -0000
@@ -164,7 +164,9 @@
 # LT_AT_EXEC_CHECK(EXECUTABLE, [STATUS = 0], [STDOUT], [STDERR])
 # --------------------------------------------------------------
 m4_define([LT_AT_EXEC_CHECK],
-[AT_CHECK([$1; lt_status=$?; if test $lt_status -eq 0; then :;
+[AT_CHECK([set dummy "$1"; set $][@; shift; lt_exe=$][1; shift;
+       if test -x $lt_exe$EXEEXT; then lt_exe=$lt_exe$EXEEXT; fi
+       eval $lt_exe "$][@"; lt_status=$?; if test $lt_status -eq 0; then :;
 	   elif test "X$host" != "X$build" && \
 	        { test -x "$1" || test -x "$1"$EXEEXT; }
 	   then (exit 77); else (exit $lt_status); fi],[$2],[$3],[$4])
@@ -175,7 +177,9 @@
 # 			  [STATUS = 0], [STDOUT], [STDERR])
 # ---------------------------------------------------------
 m4_define([LT_AT_NOINST_EXEC_CHECK],
-[AT_CHECK([$LIBTOOL --mode=execute $2 $1; lt_status=$?;
+[AT_CHECK([set dummy "$1"; set $][@; shift; lt_exe=$][1; shift; 
+       if test -x $lt_exe$EXEEXT; then lt_exe=$lt_exe$EXEEXT; fi
+       eval $LIBTOOL --mode=execute $2 $lt_exe "$][@"; lt_status=$?;
 	   if test $lt_status -eq 0; then :;
 	   elif test "X$host" != "X$build" && \
 	        { test -x "$1" || test -x "$1"$EXEEXT; }
Index: tests/demo/foo.c
===================================================================
RCS file: /sources/libtool/libtool/tests/demo/foo.c,v
retrieving revision 1.4
diff -u -r1.4 foo.c
--- tests/demo/foo.c	25 Mar 2007 12:12:43 -0000	1.4
+++ tests/demo/foo.c	13 Feb 2008 09:39:27 -0000
@@ -22,6 +22,11 @@
 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
 */
 
+/* On Windows (with parity) we need to manually import data, but only
+ * if not compiling the data itsself, so tell the header that here
+ * we don't import the variable, but define it */
+#define FOO_EXPORTS
+
 #include "foo.h"
 
 #include <stdio.h>
Index: tests/demo/foo.h
===================================================================
RCS file: /sources/libtool/libtool/tests/demo/foo.h,v
retrieving revision 1.3
diff -u -r1.3 foo.h
--- tests/demo/foo.h	25 Mar 2007 12:12:43 -0000	1.3
+++ tests/demo/foo.h	13 Feb 2008 09:39:27 -0000
@@ -62,6 +62,15 @@
 # define lt_ptr_t     char*
 #endif
 
+/* On Windows (with parity) we need to manually import data symbols.
+ * This can be done even when building static libraries, since parity
+ * handles those invalid imports correctly */
+#if defined(__PARITY__) && !defined(FOO_EXPORTS)
+# define FOO_IMPORT __declspec(dllimport)
+#else
+# define FOO_IMPORT
+#endif
+
 /* Silly constants that the functions return. */
 #define HELLO_RET 0xe110
 #define FOO_RET 0xf00
@@ -71,7 +80,7 @@
 __BEGIN_DECLS
 int foo LT_PARAMS((void));
 int hello LT_PARAMS((void));
-extern int nothing;
+extern FOO_IMPORT int nothing;
 __END_DECLS
 
 #endif /* !_FOO_H_ */
Index: tests/depdemo/l1/l1.c
===================================================================
RCS file: /sources/libtool/libtool/tests/depdemo/l1/l1.c,v
retrieving revision 1.4
diff -u -r1.4 l1.c
--- tests/depdemo/l1/l1.c	25 Mar 2007 12:12:43 -0000	1.4
+++ tests/depdemo/l1/l1.c	13 Feb 2008 09:39:27 -0000
@@ -23,6 +23,12 @@
 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
 */
 
+
+/* On Windows (with parity) we need to manually import data, but only
+ * if not compiling the data itsself, so tell the header that here
+ * we don't import the variable, but define it */
+#define L1_EXPORTS
+
 #include "l1/l1.h"
 #include <stdio.h>
 
Index: tests/depdemo/l1/l1.h
===================================================================
RCS file: /sources/libtool/libtool/tests/depdemo/l1/l1.h,v
retrieving revision 1.3
diff -u -r1.3 l1.h
--- tests/depdemo/l1/l1.h	25 Mar 2007 12:12:43 -0000	1.3
+++ tests/depdemo/l1/l1.h	13 Feb 2008 09:39:27 -0000
@@ -29,8 +29,17 @@
 
 #include "sysdep.h"
 
+/* On Windows (with parity) we need to manually import data symbols.
+ * This can be done even when building static libraries, since parity
+ * handles those invalid imports correctly */
+#if defined(__PARITY__) && !defined(L1_EXPORTS)
+# define L1_IMPORT __declspec(dllimport)
+#else
+# define L1_IMPORT
+#endif
+
 __BEGIN_DECLS
-extern int var_l1;
+extern L1_IMPORT int var_l1;
 int	func_l1 __P((int));
 __END_DECLS
 
Index: tests/depdemo/l2/l2.c
===================================================================
RCS file: /sources/libtool/libtool/tests/depdemo/l2/l2.c,v
retrieving revision 1.4
diff -u -r1.4 l2.c
--- tests/depdemo/l2/l2.c	25 Mar 2007 12:12:43 -0000	1.4
+++ tests/depdemo/l2/l2.c	13 Feb 2008 09:39:27 -0000
@@ -23,6 +23,11 @@
 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
 */
 
+/* On Windows (with parity) we need to manually import data, but only
+ * if not compiling the data itsself, so tell the header that here
+ * we don't import the variable, but define it */
+#define L2_EXPORTS
+
 #include "l2/l2.h"
 
 #include "l1/l1.h"
Index: tests/depdemo/l2/l2.h
===================================================================
RCS file: /sources/libtool/libtool/tests/depdemo/l2/l2.h,v
retrieving revision 1.3
diff -u -r1.3 l2.h
--- tests/depdemo/l2/l2.h	25 Mar 2007 12:12:43 -0000	1.3
+++ tests/depdemo/l2/l2.h	13 Feb 2008 09:39:27 -0000
@@ -29,8 +29,17 @@
 
 #include "sysdep.h"
 
+/* On Windows (with parity) we need to manually import data symbols.
+ * This can be done even when building static libraries, since parity
+ * handles those invalid imports correctly */
+#if defined(__PARITY__) && !defined(L2_EXPORTS)
+# define L2_IMPORT __declspec(dllimport)
+#else
+# define L2_IMPORT
+#endif
+
 __BEGIN_DECLS
-extern int var_l2;
+extern L2_IMPORT int var_l2;
 int	func_l2 __P((int));
 __END_DECLS
 
Index: tests/depdemo/l3/l3.c
===================================================================
RCS file: /sources/libtool/libtool/tests/depdemo/l3/l3.c,v
retrieving revision 1.4
diff -u -r1.4 l3.c
--- tests/depdemo/l3/l3.c	25 Mar 2007 12:12:43 -0000	1.4
+++ tests/depdemo/l3/l3.c	13 Feb 2008 09:39:27 -0000
@@ -23,6 +23,11 @@
 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
 */
 
+/* On Windows (with parity) we need to manually import data, but only
+ * if not compiling the data itsself, so tell the header that here
+ * we don't import the variable, but define it */
+#define L3_EXPORTS
+
 #include "l3/l3.h"
 
 #include "l1/l1.h"
Index: tests/depdemo/l3/l3.h
===================================================================
RCS file: /sources/libtool/libtool/tests/depdemo/l3/l3.h,v
retrieving revision 1.3
diff -u -r1.3 l3.h
--- tests/depdemo/l3/l3.h	25 Mar 2007 12:12:43 -0000	1.3
+++ tests/depdemo/l3/l3.h	13 Feb 2008 09:39:27 -0000
@@ -29,8 +29,17 @@
 
 #include "sysdep.h"
 
+/* On Windows (with parity) we need to manually import data symbols.
+ * This can be done even when building static libraries, since parity
+ * handles those invalid imports correctly */
+#if defined(__PARITY__) && !defined(L3_EXPORTS)
+# define L3_IMPORT __declspec(dllimport)
+#else
+# define L3_IMPORT
+#endif
+
 __BEGIN_DECLS
-extern int var_l3;
+extern L3_IMPORT int var_l3;
 int	func_l3 __P((int));
 __END_DECLS
 
Index: tests/depdemo/l4/l4.c
===================================================================
RCS file: /sources/libtool/libtool/tests/depdemo/l4/l4.c,v
retrieving revision 1.5
diff -u -r1.5 l4.c
--- tests/depdemo/l4/l4.c	25 Mar 2007 12:12:43 -0000	1.5
+++ tests/depdemo/l4/l4.c	13 Feb 2008 09:39:27 -0000
@@ -23,6 +23,11 @@
 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
 */
 
+/* On Windows (with parity) we need to manually import data, but only
+ * if not compiling the data itsself, so tell the header that here
+ * we don't import the variable, but define it */
+#define L4_EXPORTS
+
 #include "l4/l4.h"
 
 #include "l3/l3.h"
Index: tests/depdemo/l4/l4.h
===================================================================
RCS file: /sources/libtool/libtool/tests/depdemo/l4/l4.h,v
retrieving revision 1.3
diff -u -r1.3 l4.h
--- tests/depdemo/l4/l4.h	25 Mar 2007 12:12:43 -0000	1.3
+++ tests/depdemo/l4/l4.h	13 Feb 2008 09:39:27 -0000
@@ -29,8 +29,17 @@
 
 #include "sysdep.h"
 
+/* On Windows (with parity) we need to manually import data symbols.
+ * This can be done even when building static libraries, since parity
+ * handles those invalid imports correctly */
+#if defined(__PARITY__) && !defined(L4_EXPORTS)
+# define L4_IMPORT __declspec(dllimport)
+#else
+# define L4_IMPORT
+#endif
+
 __BEGIN_DECLS
-extern int var_l4;
+extern L4_IMPORT int var_l4;
 int	func_l4 __P((int));
 __END_DECLS
 
Index: tests/mdemo/foo1.c
===================================================================
RCS file: /sources/libtool/libtool/tests/mdemo/foo1.c,v
retrieving revision 1.5
diff -u -r1.5 foo1.c
--- tests/mdemo/foo1.c	25 Mar 2007 12:12:44 -0000	1.5
+++ tests/mdemo/foo1.c	13 Feb 2008 09:39:27 -0000
@@ -31,7 +31,11 @@
 #define hello	foo1_LTX_hello
 
 /* Give a global variable definition. */
-int nothing;
+
+/* When working on Windows (with or without parity) the variable needs
+ * to be initialized here (or used elsewhere in the file) to be
+ * defined in the object, otherwise its "UNDEF" */
+int nothing = 0;
 
 /* private function */
 int
Index: tests/mdemo/foo2.c
===================================================================
RCS file: /sources/libtool/libtool/tests/mdemo/foo2.c,v
retrieving revision 1.5
diff -u -r1.5 foo2.c
--- tests/mdemo/foo2.c	25 Mar 2007 12:12:44 -0000	1.5
+++ tests/mdemo/foo2.c	13 Feb 2008 09:39:27 -0000
@@ -31,7 +31,11 @@
 #define hello	libfoo2_LTX_hello
 
 /* Give a global variable definition. */
-int nothing;
+
+/* When working on Windows (with or without parity) the variable needs
+ * to be initialized here (or used elsewhere in the file) to be
+ * defined in the object, otherwise its "UNDEF" */
+int nothing = 0;
 
 /* private function */
 int
Index: tests/pdemo/foo.h
===================================================================
RCS file: /sources/libtool/libtool/tests/pdemo/foo.h,v
retrieving revision 1.4
diff -u -r1.4 foo.h
--- tests/pdemo/foo.h	25 Mar 2007 12:12:44 -0000	1.4
+++ tests/pdemo/foo.h	13 Feb 2008 09:39:27 -0000
@@ -79,6 +79,17 @@
 #  define EXTERN extern
 #endif
 
+/* On Windows (with parity) we need to manually import data symbols.
+ * This can be done even when building static libraries, since parity
+ * handles those invalid imports correctly */
+#if defined(__PARITY__) && !defined(FOO_EXPORTS)
+# define FOO_IMPORT __declspec(dllimport)
+#else
+# define FOO_IMPORT
+#endif
+
+/* Silly constants that the functions return. */
+
 /* Silly constants that the functions return. */
 #define HELLO_RET 0xe110
 #define FOO_RET 0xf00
@@ -89,7 +100,7 @@
 int foo LT_PARAMS((void));
 int foo2 LT_PARAMS((void));
 int hello LT_PARAMS((void));
-EXTERN int nothing;
+EXTERN FOO_IMPORT int nothing;
 __END_DECLS
 
 #endif /* !_FOO_H_ */
Index: tests/pdemo/longer_file_name_foo.c
===================================================================
RCS file: /sources/libtool/libtool/tests/pdemo/longer_file_name_foo.c,v
retrieving revision 1.4
diff -u -r1.4 longer_file_name_foo.c
--- tests/pdemo/longer_file_name_foo.c	25 Mar 2007 12:12:44 -0000	1.4
+++ tests/pdemo/longer_file_name_foo.c	13 Feb 2008 09:39:27 -0000
@@ -22,6 +22,11 @@
 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
 */
 
+/* On Windows (with parity) we need to manually import data, but only
+ * if not compiling the data itsself, so tell the header that here
+ * we don't import the variable, but define it */
+#define FOO_EXPORTS
+
 #define _LIBFOO_COMPILATION_
 #include "foo.h"
 #undef _LIBFOO_COMPILATION_
